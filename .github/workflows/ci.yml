name: CI

on:
  push:
    branches:
      - "main"
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  build-and-verify:
    strategy:
      matrix:
        os: [ubuntu-24.04, macos-latest]
        include:
          - os: ubuntu-24.04
            verus-release: verus-x86-linux
          - os: macos-latest
            verus-release: verus-arm64-macos
    runs-on: ${{ matrix.os }}
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.91.0

      - name: Download Verus
        run: |
          # Get the download URL for the specific asset from the latest release
          echo "Fetching release info..."
          RELEASE_JSON=$(curl -sL https://api.github.com/repos/verus-lang/verus/releases/latest)

          # Check if response is valid JSON
          if ! echo "$RELEASE_JSON" | grep -q "browser_download_url"; then
            echo "Error: Invalid API response or rate limited"
            echo "Response preview:"
            echo "$RELEASE_JSON" | head -20
            sleep 60
            RELEASE_JSON=$(curl -sL https://api.github.com/repos/verus-lang/verus/releases/latest)
          fi

          # Extract platform identifier from verus-release (e.g., "x86-linux" from "verus-x86-linux")
          PLATFORM="${{ matrix.verus-release }}"
          PLATFORM="${PLATFORM#verus-}"  # Remove "verus-" prefix
          echo "Looking for platform: $PLATFORM"

          # Find asset URL that contains the platform identifier
          ASSET_URL=$(echo "$RELEASE_JSON" | grep "browser_download_url.*${PLATFORM}.zip" | cut -d '"' -f 4 | head -1)

          if [ -z "$ASSET_URL" ]; then
            echo "Error: Could not find asset URL for platform ${PLATFORM}"
            echo "Available assets:"
            echo "$RELEASE_JSON" | grep "browser_download_url"
            exit 1
          fi

          echo "Downloading from: $ASSET_URL"
          curl -L -o verus.zip "$ASSET_URL"
          unzip verus.zip

          # Find the extracted directory and rename to "verus"
          # The extracted dir will be like "verus-arm64-macos" or "verus-x86-linux"
          EXTRACTED_DIR=$(find . -maxdepth 1 -name "verus-*" -type d | grep -v ".git" | head -1)
          if [ -z "$EXTRACTED_DIR" ]; then
            echo "Error: Could not find extracted directory"
            ls -la
            exit 1
          fi
          echo "Found extracted directory: $EXTRACTED_DIR"
          mv "$EXTRACTED_DIR" verus

      - name: Setup Verus (macOS)
        if: runner.os == 'macOS'
        run: |
          cd verus
          bash macos_allow_gatekeeper.sh || true

      - name: Install Verus Rust toolchain
        run: |
          # Run verus to get the required toolchain version and install it
          cd verus
          ./verus --version || true
          # Extract the required toolchain from verus output and install if needed
          TOOLCHAIN=$(./verus 2>&1 | grep -oE '1\.[0-9]+\.[0-9]+-[a-z0-9_-]+' | head -1 || echo "")
          if [ -n "$TOOLCHAIN" ]; then
            rustup install "$TOOLCHAIN" || true
          fi

      - name: Add Verus to PATH
        run: |
          echo "${{ github.workspace }}/verus" >> $GITHUB_PATH

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            vest/target
            vest-dsl/target
            vest-examples/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      # Step 1: vest - cargo verus build --expand-errors
      - name: vest - cargo verus build (with verification)
        working-directory: ./vest
        run: |
          cargo verus build -- --expand-errors

      # Step 1: vest - cargo build --release
      - name: vest - cargo build --release
        working-directory: ./vest
        run: |
          cargo build --release

      # Step 2: vest-dsl - cargo build --release
      - name: vest-dsl - cargo build --release
        working-directory: ./vest-dsl
        run: |
          cargo build --release

      - name: Add vest compiler to PATH
        run: |
          echo "${{ github.workspace }}/vest-dsl/target/release" >> $GITHUB_PATH

      # Step 3: vest-examples - cargo verus verify --expand-errors
      - name: vest-examples - cargo verus verify
        working-directory: ./vest-examples
        run: |
          cargo verus verify --workspace --exclude tls_dsl -- --expand-errors

      # Step 4: Download benchmark data and run benchmarks
      - name: Download benchmark data
        run: |
          mkdir -p vest-examples/bitcoin_dsl/benches/data
          curl -L -o vest-examples/bitcoin_dsl/benches/data/sampled_blocks.txt https://github.com/y1ca1/vest/releases/download/v0.1.2/sampled_blocks.txt

      - name: vest-examples/tls_dsl - cargo bench
        working-directory: ./vest-examples/tls_dsl
        run: |
          cargo bench --no-run

      # Step 5: vest-examples/bitcoin_dsl - cargo bench
      - name: vest-examples/bitcoin_dsl - cargo bench
        working-directory: ./vest-examples/bitcoin_dsl
        run: |
          cargo bench --no-run
